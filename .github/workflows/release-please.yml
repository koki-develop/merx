name: Release Please

permissions: {}

defaults:
  run:
    shell: bash

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-please:
    name: Release Please
    timeout-minutes: 5
    runs-on: ubuntu-latest
    permissions:
      contents: write # for creating releases
      pull-requests: write # for creating PRs
      issues: write # for creating labels
    outputs:
      should-release: ${{ steps.release-please.outputs.release_created }}
      tag: ${{ steps.release-please.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release-please
        with:
          token: ${{ github.token }}
          release-type: rust

  build:
    name: Build (${{ matrix.target }})
    needs: release-please
    if: needs.release-please.outputs.should-release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            use-cross: false
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            use-cross: true
          - target: x86_64-apple-darwin
            os: macos-15-intel
            use-cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            use-cross: false
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            use-cross: false
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    permissions:
      contents: read
    env:
      TARGET: ${{ matrix.target }}
      USE_CROSS: ${{ matrix.use-cross }}
      TAG: ${{ needs.release-please.outputs.tag }}
    steps:
      # ============================================================
      # Setup
      # ============================================================

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./.github/actions/setup

      - name: Add target
        run: rustup target add "$TARGET"

      # ============================================================
      # Build
      # ============================================================

      - name: Install cross
        if: matrix.use-cross
        run: cargo install cross --locked

      - name: Build
        run: |
          if [ "$USE_CROSS" = "true" ]; then
            cross build --release --locked --target "$TARGET"
          else
            cargo build --release --locked --target "$TARGET"
          fi

      # ============================================================
      # Archive
      # ============================================================

      - name: Create archive (Unix)
        if: runner.os != 'Windows'
        run: |
          ARCHIVE_NAME="merx-${TAG}-${TARGET}.tar.gz"
          mkdir -p archive
          cp "target/${TARGET}/release/merx" archive/
          cp LICENSE README.md archive/
          tar czvf "$ARCHIVE_NAME" -C archive .
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> "$GITHUB_ENV"

      - name: Create archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ARCHIVE_NAME = "merx-${env:TAG}-${env:TARGET}.zip"
          New-Item -ItemType Directory -Force -Path archive
          Copy-Item "target/${env:TARGET}/release/merx.exe" -Destination archive/
          Copy-Item "LICENSE", "README.md" -Destination archive/
          Compress-Archive -Path archive/* -DestinationPath $ARCHIVE_NAME
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $env:GITHUB_ENV

      # ============================================================
      # Checksum
      # ============================================================

      - name: Generate checksum (Unix)
        if: runner.os != 'Windows'
        run: sha256sum "$ARCHIVE_NAME" > "$ARCHIVE_NAME.sha256"

      - name: Generate checksum (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $hash = (Get-FileHash -Algorithm SHA256 $env:ARCHIVE_NAME).Hash.ToLower()
          "$hash  $env:ARCHIVE_NAME" | Out-File -Encoding ASCII "$env:ARCHIVE_NAME.sha256"

      # ============================================================
      # Upload artifacts
      # ============================================================

      - name: Upload artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: artifacts-${{ matrix.target }}
          path: |
            merx-*.tar.gz
            merx-*.zip
            merx-*.sha256
          if-no-files-found: error
          retention-days: 7

  upload:
    name: Upload Release Assets
    needs: [release-please, build]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write # for uploading release assets
    env:
      TAG: ${{ needs.release-please.outputs.tag }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: artifacts-*
          merge-multiple: true

      - name: Upload to release
        run: gh release upload "$TAG" merx-*.tar.gz merx-*.zip merx-*.sha256 --clobber
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

  homebrew-tap:
    name: Update Homebrew Tap
    needs:
      - upload
      - release-please
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    env:
      TAG: ${{ needs.release-please.outputs.tag }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: ./.github/actions/setup

      - name: Download checksums and generate formula
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          VERSION="${TAG#v}"

          extract_sha256() {
            local target="$1"
            local filename="merx-${TAG}-${target}.tar.gz.sha256"
            gh release download "$TAG" --pattern "$filename" --output - | awk '{print $1}'
          }

          SHA256_X86_64_APPLE=$(extract_sha256 "x86_64-apple-darwin")
          SHA256_AARCH64_APPLE=$(extract_sha256 "aarch64-apple-darwin")
          SHA256_X86_64_LINUX=$(extract_sha256 "x86_64-unknown-linux-gnu")
          SHA256_AARCH64_LINUX=$(extract_sha256 "aarch64-unknown-linux-gnu")

          for var in SHA256_X86_64_APPLE SHA256_AARCH64_APPLE SHA256_X86_64_LINUX SHA256_AARCH64_LINUX; do
            value="${!var}"
            if [[ -z "$value" || ${#value} -ne 64 ]]; then
              echo "Error: Invalid SHA256 for $var: '$value'" >&2
              exit 1
            fi
          done

          cat > ./merx.rb << EOF
          class Merx < Formula
            desc "Run your flowcharts"
            homepage "https://github.com/koki-develop/merx"
            version "${VERSION}"
            license "MIT"

            on_macos do
              on_intel do
                url "https://github.com/koki-develop/merx/releases/download/v#{version}/merx-v#{version}-x86_64-apple-darwin.tar.gz"
                sha256 "${SHA256_X86_64_APPLE}"
              end
              on_arm do
                url "https://github.com/koki-develop/merx/releases/download/v#{version}/merx-v#{version}-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA256_AARCH64_APPLE}"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/koki-develop/merx/releases/download/v#{version}/merx-v#{version}-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA256_X86_64_LINUX}"
              end
              on_arm do
                url "https://github.com/koki-develop/merx/releases/download/v#{version}/merx-v#{version}-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA256_AARCH64_LINUX}"
              end
            end

            def install
              bin.install "merx"
            end

            test do
              system "#{bin}/merx", "--help"
            end
          end
          EOF

          echo "Generated merx.rb for version ${VERSION}"
          cat ./merx.rb

      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ secrets.HOMEBREW_TAP_APP_ID }}
          private-key: ${{ secrets.HOMEBREW_TAP_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: homebrew-tap
          permission-contents: write # for updating files
      - name: Update Homebrew Formula
        run: |
          SHA=$(gh api repos/koki-develop/homebrew-tap/contents/Formula/merx.rb --jq '.sha')
          gh api --method PUT repos/koki-develop/homebrew-tap/contents/Formula/merx.rb \
            --field message="chore: update merx to $TAG" \
            --field content=@<(base64 -i ./merx.rb) \
            --field sha="$SHA"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

  docker:
    name: Push Docker Image
    needs:
      - upload
      - release-please
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write # for pushing to ghcr.io
    env:
      TAG: ${{ needs.release-please.outputs.tag }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        env:
          DOCKER_METADATA_ANNOTATIONS_LEVELS: manifest,index
        with:
          images: ghcr.io/koki-develop/merx
          tags: |
            type=semver,pattern={{version}},value=${{ env.TAG }}
            type=semver,pattern={{major}}.{{minor}},value=${{ env.TAG }}
            type=semver,pattern={{major}},value=${{ env.TAG }}

      - name: Set version
        run: echo "VERSION=${TAG#v}" >> "$GITHUB_ENV"

      - name: Build and push
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: dockerfiles/bookworm-slim.Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          build-args: |
            VERSION=${{ env.VERSION }}
